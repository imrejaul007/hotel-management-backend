{{> admin/header title="Booking Management"}}

<div class="container-fluid">
    <!-- Booking Statistics -->
    <div class="row mb-4">
        <div class="col-xl-2 col-md-4 mb-3">
            <div class="card border-left-primary shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">Total Bookings</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">{{stats.totalBookings}}</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-calendar fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-2 col-md-4 mb-3">
            <div class="card border-left-success shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-success text-uppercase mb-1">Today's Check-ins</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">{{stats.todayCheckIns}}</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-sign-in-alt fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-2 col-md-4 mb-3">
            <div class="card border-left-info shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-info text-uppercase mb-1">Today's Check-outs</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">{{stats.todayCheckOuts}}</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-sign-out-alt fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-2 col-md-4 mb-3">
            <div class="card border-left-warning shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">Occupied Rooms</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">{{stats.occupiedRooms}}</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-bed fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-2 col-md-4 mb-3">
            <div class="card border-left-danger shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-danger text-uppercase mb-1">Upcoming Bookings</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">{{stats.upcomingBookings}}</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-clock fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-2 col-md-4 mb-3">
            <div class="card border-left-primary shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">Total Revenue</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">${{formatNumber stats.revenue.totalRevenue}}</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-dollar-sign fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Booking List Card -->
    <div class="card shadow mb-4">
        <div class="card-header py-3 d-flex justify-content-between align-items-center">
            <h6 class="m-0 font-weight-bold text-primary">All Bookings</h6>
            <div class="btn-group">
                <a href="/admin/bookings/current" class="btn btn-info btn-sm">
                    <i class="fas fa-clock"></i> Current
                </a>
                <a href="/admin/bookings/upcoming" class="btn btn-success btn-sm">
                    <i class="fas fa-calendar-alt"></i> Upcoming
                </a>
                <a href="/admin/bookings/past" class="btn btn-secondary btn-sm">
                    <i class="fas fa-history"></i> Past
                </a>
            </div>
        </div>
        <div class="card-body">
            <!-- Filters -->
            <div class="row mb-3">
                <div class="col-md-3">
                    <label class="form-label">Booking Source</label>
                    <select class="form-select" id="sourceFilter">
                        <option value="">All Sources</option>
                        <option value="website" {{#if (eq filters.source 'website')}}selected{{/if}}>Website</option>
                        <option value="walk_in" {{#if (eq filters.source 'walk_in')}}selected{{/if}}>Walk-in</option>
                        <option value="ota" {{#if (eq filters.source 'ota')}}selected{{/if}}>OTA Platform</option>
                        <option value="corporate" {{#if (eq filters.source 'corporate')}}selected{{/if}}>Corporate</option>
                        <option value="phone" {{#if (eq filters.source 'phone')}}selected{{/if}}>Phone</option>
                        <option value="email" {{#if (eq filters.source 'email')}}selected{{/if}}>Email</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Status</label>
                    <select class="form-select" id="statusFilter">
                        <option value="">All Statuses</option>
                        <option value="confirmed" {{#if (eq filters.status 'confirmed')}}selected{{/if}}>Confirmed</option>
                        <option value="pending" {{#if (eq filters.status 'pending')}}selected{{/if}}>Pending</option>
                        <option value="checked_in" {{#if (eq filters.status 'checked_in')}}selected{{/if}}>Checked In</option>
                        <option value="checked_out" {{#if (eq filters.status 'checked_out')}}selected{{/if}}>Checked Out</option>
                        <option value="cancelled" {{#if (eq filters.status 'cancelled')}}selected{{/if}}>Cancelled</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Start Date</label>
                    <input type="date" class="form-control" id="startDateFilter" value="{{filters.startDate}}">
                </div>
                <div class="col-md-3">
                    <label class="form-label">End Date</label>
                    <input type="date" class="form-control" id="endDateFilter" value="{{filters.endDate}}">
                </div>
            </div>

            <!-- Bookings Table -->
            <div class="table-responsive">
                <table class="table table-bordered" id="bookingsTable" width="100%" cellspacing="0">
                    <thead>
                        <tr>
                            <th>Booking ID</th>
                            <th>Guest</th>
                            <th>Room</th>
                            <th>Dates</th>
                            <th>Source</th>
                            <th>Status</th>
                            <th>Amount</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {{#each bookings}}
                        <tr>
                            <td>
                                <small class="text-muted">#{{_id}}</small><br>
                                {{formatDate createdAt}}
                            </td>
                            <td>
                                <strong>{{user.name}}</strong><br>
                                <small>{{user.email}}</small><br>
                                {{#if user.phone}}
                                <small>{{formatPhone user.phone}}</small>
                                {{/if}}
                            </td>
                            <td>
                                <strong>{{room.type}} - {{room.number}}</strong><br>
                                {{hotel.name}}<br>
                                <small>{{hotel.location}}</small>
                            </td>
                            <td>
                                <strong>Check-in:</strong> {{formatDate checkIn}}<br>
                                <strong>Check-out:</strong> {{formatDate checkOut}}<br>
                                <small>{{nights}} nights</small>
                            </td>
                            <td>
                                <span class="badge bg-info">{{bookingSourceDisplay}}</span>
                                {{#if corporateAccount}}
                                <br><small>{{corporateAccount.companyName}}</small>
                                {{/if}}
                            </td>
                            <td>
                                <span class="badge bg-{{statusColor status}}">{{formatBookingStatus status}}</span>
                            </td>
                            <td>
                                ${{formatNumber totalAmount}}<br>
                                {{#if payment}}
                                <span class="badge bg-{{paymentStatusColor payment.status}}">
                                    {{formatPaymentStatus payment.status}}
                                </span>
                                {{/if}}
                            </td>
                            <td>
                                <div class="btn-group">
                                    <a href="/admin/bookings/{{_id}}" class="btn btn-info btn-sm">
                                        <i class="fas fa-eye"></i>
                                    </a>
                                    <button type="button" class="btn btn-primary btn-sm" onclick="editBooking('{{_id}}')">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button type="button" class="btn btn-danger btn-sm" onclick="cancelBooking('{{_id}}')">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {{/each}}
                    </tbody>
                </table>
            </div>

            <!-- Pagination -->
            {{> admin/pagination}}
        </div>
    </div>
</div>

<script>
// Filter handling
document.getElementById('sourceFilter').addEventListener('change', applyFilters);
document.getElementById('statusFilter').addEventListener('change', applyFilters);
document.getElementById('startDateFilter').addEventListener('change', applyFilters);
document.getElementById('endDateFilter').addEventListener('change', applyFilters);

function applyFilters() {
    const source = document.getElementById('sourceFilter').value;
    const status = document.getElementById('statusFilter').value;
    const startDate = document.getElementById('startDateFilter').value;
    const endDate = document.getElementById('endDateFilter').value;

    let url = '/admin/bookings?';
    if (source) url += `source=${source}&`;
    if (status) url += `status=${status}&`;
    if (startDate) url += `startDate=${startDate}&`;
    if (endDate) url += `endDate=${endDate}&`;

    window.location.href = url;
}

// Booking actions
async function editBooking(id) {
    window.location.href = `/admin/bookings/${id}/edit`;
}

async function cancelBooking(id) {
    if (!confirm('Are you sure you want to cancel this booking?')) return;

    try {
        const response = await fetch(`/admin/bookings/${id}/status`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ status: 'cancelled' })
        });

        const data = await response.json();
        if (data.success) {
            showAlert('success', 'Booking cancelled successfully');
            setTimeout(() => window.location.reload(), 1500);
        } else {
            showAlert('error', data.message || 'Failed to cancel booking');
        }
    } catch (error) {
        console.error('Error cancelling booking:', error);
        showAlert('error', 'Failed to cancel booking');
    }
}
</script>

{{> admin/footer}}
