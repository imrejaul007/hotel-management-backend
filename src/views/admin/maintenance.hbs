{{> admin/header}}
{{> admin/sidebar}}

<div class="main-content">
    <div class="container-fluid">
        <!-- Page Header -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="h3">Maintenance Management</h1>
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addMaintenanceModal">
                <i class="fas fa-plus"></i> Add New Task
            </button>
        </div>

        <!-- Filters -->
        <div class="card mb-4">
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-3">
                        <input type="text" id="searchInput" class="form-control" placeholder="Search tasks...">
                    </div>
                    <div class="col-md-2">
                        <select id="statusFilter" class="form-select">
                            <option value="">All Status</option>
                            <option value="pending">Pending</option>
                            <option value="in-progress">In Progress</option>
                            <option value="completed">Completed</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <select id="priorityFilter" class="form-select">
                            <option value="">All Priority</option>
                            <option value="low">Low</option>
                            <option value="medium">Medium</option>
                            <option value="high">High</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <select id="locationFilter" class="form-select">
                            <option value="">All Locations</option>
                            {{#each locations}}
                            <option value="{{this}}">{{this}}</option>
                            {{/each}}
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tasks Table -->
        <div class="card">
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Title</th>
                                <th>Location</th>
                                <th>Priority</th>
                                <th>Status</th>
                                <th>Due Date</th>
                                <th>Assigned To</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="maintenanceTableBody">
                            {{#each tasks}}
                            <tr>
                                <td>
                                    <div class="d-flex align-items-center">
                                        <span class="ms-2">{{title}}</span>
                                    </div>
                                </td>
                                <td>{{location}}</td>
                                <td>
                                    <span class="badge bg-{{priorityColor priority}}">{{priority}}</span>
                                </td>
                                <td>
                                    <span class="badge bg-{{statusColor status}}">{{status}}</span>
                                </td>
                                <td>{{formatDate dueDate}}</td>
                                <td>{{assignedTo}}</td>
                                <td>
                                    <div class="btn-group">
                                        <button class="btn btn-sm btn-info" onclick="viewTask('{{_id}}')">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                        <button class="btn btn-sm btn-primary" onclick="editTask('{{_id}}')">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button class="btn btn-sm btn-danger" onclick="deleteTask('{{_id}}')">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {{/each}}
                        </tbody>
                    </table>
                </div>

                <!-- Pagination -->
                <div class="d-flex justify-content-between align-items-center mt-4">
                    <div class="text-muted">
                        Showing <span id="startCount">{{startCount}}</span> to <span id="endCount">{{endCount}}</span> of <span id="totalCount">{{totalCount}}</span> tasks
                    </div>
                    <nav>
                        <ul class="pagination mb-0">
                            {{#if hasPrevPage}}
                            <li class="page-item">
                                <a class="page-link" href="?page={{prevPage}}" aria-label="Previous">
                                    <span aria-hidden="true">&laquo;</span>
                                </a>
                            </li>
                            {{/if}}
                            {{#each pages}}
                            <li class="page-item {{#if active}}active{{/if}}">
                                <a class="page-link" href="?page={{number}}">{{number}}</a>
                            </li>
                            {{/each}}
                            {{#if hasNextPage}}
                            <li class="page-item">
                                <a class="page-link" href="?page={{nextPage}}" aria-label="Next">
                                    <span aria-hidden="true">&raquo;</span>
                                </a>
                            </li>
                            {{/if}}
                        </ul>
                    </nav>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add/Edit Maintenance Modal -->
<div class="modal fade" id="maintenanceModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalTitle">Add New Maintenance Task</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="maintenanceForm">
                    <input type="hidden" id="taskId">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">Title</label>
                            <input type="text" class="form-control" id="title" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Location</label>
                            <select class="form-select" id="location" required>
                                <option value="">Select Location</option>
                                {{#each locations}}
                                <option value="{{this}}">{{this}}</option>
                                {{/each}}
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Priority</label>
                            <select class="form-select" id="priority" required>
                                <option value="low">Low</option>
                                <option value="medium">Medium</option>
                                <option value="high">High</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Status</label>
                            <select class="form-select" id="status" required>
                                <option value="pending">Pending</option>
                                <option value="in-progress">In Progress</option>
                                <option value="completed">Completed</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Due Date</label>
                            <input type="date" class="form-control" id="dueDate" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Assigned To</label>
                            <select class="form-select" id="assignedTo" required>
                                <option value="">Select Staff</option>
                                {{#each staff}}
                                <option value="{{_id}}">{{name}}</option>
                                {{/each}}
                            </select>
                        </div>
                        <div class="col-12">
                            <label class="form-label">Description</label>
                            <textarea class="form-control" id="description" rows="3" required></textarea>
                        </div>
                        <div class="col-12">
                            <label class="form-label">Notes</label>
                            <textarea class="form-control" id="notes" rows="2"></textarea>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveTask()">Save Task</button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Delete Maintenance Task</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this maintenance task? This action cannot be undone.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" onclick="confirmDelete()">Delete</button>
            </div>
        </div>
    </div>
</div>

<script>
let currentTaskId = null;

// Initialize DataTable
$(document).ready(function() {
    // Initialize date picker
    flatpickr("#dueDate", {
        dateFormat: "Y-m-d",
        minDate: "today"
    });

    // Handle search input
    $("#searchInput").on("keyup", function() {
        const value = $(this).val().toLowerCase();
        $("#maintenanceTableBody tr").filter(function() {
            $(this).toggle($(this).text().toLowerCase().indexOf(value) > -1)
        });
    });

    // Handle filters
    $("#statusFilter, #priorityFilter, #locationFilter").on("change", function() {
        filterTasks();
    });
});

function filterTasks() {
    const status = $("#statusFilter").val();
    const priority = $("#priorityFilter").val();
    const location = $("#locationFilter").val();

    $("#maintenanceTableBody tr").each(function() {
        const row = $(this);
        const rowStatus = row.find("td:eq(3)").text().toLowerCase();
        const rowPriority = row.find("td:eq(2)").text().toLowerCase();
        const rowLocation = row.find("td:eq(1)").text();

        const statusMatch = !status || rowStatus.includes(status);
        const priorityMatch = !priority || rowPriority === priority;
        const locationMatch = !location || rowLocation === location;

        row.toggle(statusMatch && priorityMatch && locationMatch);
    });
}

function viewTask(id) {
    fetch(`/api/admin/maintenance/${id}`)
        .then(response => response.json())
        .then(task => {
            $("#modalTitle").text("View Maintenance Task");
            populateForm(task);
            $("#maintenanceForm :input").prop("disabled", true);
            $(".modal-footer").hide();
            $("#maintenanceModal").modal("show");
        });
}

function editTask(id) {
    fetch(`/api/admin/maintenance/${id}`)
        .then(response => response.json())
        .then(task => {
            $("#modalTitle").text("Edit Maintenance Task");
            populateForm(task);
            $("#maintenanceForm :input").prop("disabled", false);
            $(".modal-footer").show();
            currentTaskId = id;
            $("#maintenanceModal").modal("show");
        });
}

function populateForm(task) {
    $("#title").val(task.title);
    $("#location").val(task.location);
    $("#priority").val(task.priority);
    $("#status").val(task.status);
    $("#dueDate").val(task.dueDate.split('T')[0]);
    $("#assignedTo").val(task.assignedTo);
    $("#description").val(task.description);
    $("#notes").val(task.notes);
}

function saveTask() {
    const taskData = {
        title: $("#title").val(),
        location: $("#location").val(),
        priority: $("#priority").val(),
        status: $("#status").val(),
        dueDate: $("#dueDate").val(),
        assignedTo: $("#assignedTo").val(),
        description: $("#description").val(),
        notes: $("#notes").val()
    };

    const url = currentTaskId 
        ? `/api/admin/maintenance/${currentTaskId}`
        : '/api/admin/maintenance';
    const method = currentTaskId ? 'PUT' : 'POST';

    fetch(url, {
        method: method,
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(taskData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            $("#maintenanceModal").modal("hide");
            window.location.reload();
        } else {
            alert(data.message || 'Error saving task');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error saving task');
    });
}

function deleteTask(id) {
    currentTaskId = id;
    $("#deleteModal").modal("show");
}

function confirmDelete() {
    if (!currentTaskId) return;

    fetch(`/api/admin/maintenance/${currentTaskId}`, {
        method: 'DELETE'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            $("#deleteModal").modal("hide");
            window.location.reload();
        } else {
            alert(data.message || 'Error deleting task');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error deleting task');
    });
}
</script>
